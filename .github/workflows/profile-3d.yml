name: Generate 3D Profile

on:
  schedule:
    - cron: "15 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Render 3D contributions
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: bujhmml
      - name: Normalize output filename and enforce monochrome
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          base = Path("profile-3d-contrib")
          base.mkdir(exist_ok=True)

          preferred = base / "profile-night-rainbow.svg"
          candidates = [
              preferred,
              base / "profile-night.svg",
              base / "profile-3d-contrib.svg",
          ] + sorted(base.glob("*.svg"))

          source = None
          for cand in candidates:
              if cand.exists():
                  source = cand
                  break

          if source is None:
              preferred.write_text("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 10'></svg>")
              source = preferred

          if source != preferred:
              preferred.write_text(source.read_text())

          def to_gray(match: re.Match) -> str:
              hex_value = match.group(1)
              if len(hex_value) == 3:
                  hex_value = "".join(ch * 2 for ch in hex_value)
              r = int(hex_value[0:2], 16)
              g = int(hex_value[2:4], 16)
              b = int(hex_value[4:6], 16)
              gray = int(0.299 * r + 0.587 * g + 0.114 * b)
              channel = f"{gray:02x}"
              return f'"#{channel}{channel}{channel}"'

          text = preferred.read_text()
          text = re.sub(r'"#([0-9a-fA-F]{3,6})"', to_gray, text)
          preferred.write_text(text)
          PY
      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Commit and push if changed
        run: |
          set -e
          git add profile-3d-contrib/*
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update 3d contributions"
          attempt=0
          until [ $attempt -ge 3 ]; do
            git pull --rebase origin main && git push origin HEAD:main && exit 0
            attempt=$((attempt+1))
            echo "Push failed, retry $attempt/3"
            sleep 3
          done
          exit 1
