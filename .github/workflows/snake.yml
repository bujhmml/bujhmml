name: Generate Snake

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  snake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Prepare dist folder
        run: mkdir -p dist
      - name: Generate snake animation
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: bujhmml
          outputs: |
            dist/github-contribution-grid-snake.svg
      - name: Duplicate dark variant
        run: cp dist/github-contribution-grid-snake.svg dist/github-contribution-grid-snake-dark.svg
      - name: Enforce monochrome palette
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          targets = [
              Path("dist/github-contribution-grid-snake.svg"),
              Path("dist/github-contribution-grid-snake-dark.svg"),
          ]

          def to_gray(match: re.Match) -> str:
              hex_value = match.group(1)
              if len(hex_value) == 3:
                  hex_value = "".join(ch * 2 for ch in hex_value)
              r = int(hex_value[0:2], 16)
              g = int(hex_value[2:4], 16)
              b = int(hex_value[4:6], 16)
              gray = int(0.299 * r + 0.587 * g + 0.114 * b)
              channel = f"{gray:02x}"
              return f'"#{channel}{channel}{channel}"'

          for path in targets:
              if not path.exists():
                  continue
              text = path.read_text()
              text = re.sub(r'"#([0-9a-fA-F]{3,6})"', to_gray, text)
              path.write_text(text)
          PY
      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      - name: Commit and push if changed
        run: |
          set -e
          git add dist/github-contribution-grid-snake.svg dist/github-contribution-grid-snake-dark.svg
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "chore: update snake"
          attempt=0
          until [ $attempt -ge 3 ]; do
            git pull --rebase origin main && git push origin HEAD:main && exit 0
            attempt=$((attempt+1))
            echo "Push failed, retry $attempt/3"
            sleep 3
          done
          exit 1
